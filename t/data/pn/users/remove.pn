;;
;; users/delete.pn
;; Pendulum Test Script
;;

SET %F "t/tmp/pn/users/passwd"
COPY %F %A
CALL &PWDB.OPEN
OK? @pwdb.open.fail

SET %E "t/tmp/pn/users/shadow"
COPY %E %A
CALL &SPDB.OPEN
OK? @spdb.open.fail

SET %A 1       ;; by username
SET %B "user"
CALL &USER.FIND
OK? @missing

PRINT "found user 'user'\n"
CALL &USER.REMOVE
OK? @remove-failed

COPY %F %A
CALL &PWDB.WRITE
OK? @update-failed
CALL &PWDB.CLOSE
OK? @update-failed

CALL &PWDB.OPEN
OK? @pwdb.open.fail

COPY %E %A
CALL &SPDB.WRITE
OK? @update-failed
CALL &SPDB.CLOSE
OK? @update-failed

CALL &SPDB.OPEN
OK? @spdb.open.fail

SET %A 1       ;; by username
SET %B "user"
CALL &USER.FIND
OK? @deleted
PRINT "found user 'user', post-delete\n"
HALT

pwdb.open.fail:
  PRINT "Failed to open passwd file\n"
  SYSERR
  HALT

spdb.open.fail:
  PRINT "Failed to open shadow file\n"
  SYSERR
  HALT

missing:
  PRINT "user not found, pre-delete\n"
  HALT

deleted:
  PRINT "user not found, post-delete\n"
  HALT

remove-failed:
  PRINT "failed to delete user\n"
  SYSERR
  HALT

update-failed:
  PRINT "failed to update user\n"
  SYSERR
  HALT

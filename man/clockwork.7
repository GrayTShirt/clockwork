.\" Automatically generated by Pod::Man 2.27 (Pod::Simple 3.28)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "CLOCKWORK 7"
.TH CLOCKWORK 7 "2014-09-13" "Clockwork v2.3.0" "Clockwork Manual"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
clockwork \- Configuration Management System
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
\&\fBClockwork\fR
is a system configuration management system designed to securely enforce
policies on one or more host systems.  It can ensure that files have the
prescribed attributes (owner, group, permissions, etc.) and content.  It
can maintain a specific set of installed packages, and even make sure that
system user accounts exist.
.PP
The \fImanifest\fR defines the resources that Clockwork
manages.  These definitions are grouped together into policies
that are then applied to hosts.
.PP
This document is both a gentle introduction to the manifest
language and a full reference for its constructs.
.SH "INTRODUCTION"
.IX Header "INTRODUCTION"
Let's start out by writing a simple, yet complete manifest for a
small web hosting firm named Widgets, Inc.
.IP "lab1.widgets.net" 4
.IX Item "lab1.widgets.net"
Test lab virtual machine running CentOS 5.5, for staging
updates to the production environment.
.IP "buildhost.widgets.net" 4
.IX Item "buildhost.widgets.net"
\&\s-1RPM\s0 build host and \s-1YUM\s0 repository; CentOS 5.2.
.IP "dev.widgets.net" 4
.IX Item "dev.widgets.net"
General-purpose development server, shared by three staff developers
and one freelance designer.  Runs Ubuntu 9.10.
.IP "prodweb1.widgets.net" 4
.IX Item "prodweb1.widgets.net"
Production Apache web cluster node; CentOS 5.5
.IP "prodweb2.widgets.net" 4
.IX Item "prodweb2.widgets.net"
Production Apache web cluster node; CentOS 5.5
.IP "proddb1.widgets.net" 4
.IX Item "proddb1.widgets.net"
Production MySQL database server on Oracle Enterprise Linux 5.4
.IP "proddb2.widgets.net" 4
.IX Item "proddb2.widgets.net"
Production MySQL database server on Oracle Enterprise Linux 5.4
.IP "clockwork.widgets.net" 4
.IX Item "clockwork.widgets.net"
Clockwork Policy Master for above servers.
.PP
This mix of hosts will let us explore some of the more powerful
concepts behind the Clockwork manifest language.
.SS "Preparation"
.IX Subsection "Preparation"
This tutorial assumes that the Clockwork software is installed on all
servers, and that the policy master and agent are able to communicate.
Default configuration is assumed.
.SS "Getting Started"
.IX Subsection "Getting Started"
Let's start out by looking at the classical example given by most
configuration management tutorials: the \fBsudoers\fR(5) file.
.PP
The /etc/sudoers file governs who can issue the \fBsudo\fR(8) command
to assume the identity of another user (usually root).  For security
reasons, \fBsudo\fR will refuse to run if the permissions on
/etc/sudoers are not 0440, or the file is not owned by root:root.
.PP
We can use Clockwork to make sure that this is the case.  Create a new
manifest file in /etc/clockwork/manifest.pol:
.PP
.Vb 5
\&    ############################################################
\&    # /etc/clockwork/manifest.pol
\&    #
\&    # Widgets, Inc. Policy Manifest
\&    #
\&
\&    policy "security" {
\&
\&        # Ensure that /etc/sudoers is usable
\&        file "/etc/sudoers" {
\&            owner: "root"
\&            group: "root"
\&            mode:  0440
\&        }
\&    }
\&
\&    ############################################################
.Ve
.PP
First, a few syntax notes.
.PP
Comments start with '#' and continue to the end of the line.
.PP
We defined a new policy, named \*(L"security\*(R", with the \fBpolicy\fR
directive.  The definition of the policy starts at the first curly
brace ({) and continues until the matching '}'.
.PP
Inside this policy, we defined a file resource to represent the
/etc/sudoers file.  We'll get into resources later.  For now,
let's move on.
.PP
Before client hosts can use your policy, however, you will have
to tell the policy master which hosts the policy applies to.
This is done through \fBhost enforcements.\fR
.PP
Add the following host definition to the manifest file:
.PP
.Vb 3
\&    host "lab1.widgets.net" {
\&        enforce "security"
\&    }
.Ve
.PP
This will cause the policy master to send the \*(L"security\*(R" policy
to \fIlab1.widgets.net\fR
when it connects.  We only specified the lab1 host so that we
could test the policy on the staging server before pushing it
out to the whole network.  Let's add the rest of the servers:
.PP
.Vb 5
\&    ############################################################
\&    # /etc/clockwork/manifest.pol
\&    #
\&    # Widgets, Inc. Policy Manifest
\&    #
\&
\&    policy "security" {
\&
\&        # Ensure that /etc/sudoers is usable
\&        file "/etc/sudoers" {
\&            owner: "root"
\&            group: "root"
\&            mode:  0440
\&        }
\&    }
\&
\&    host "lab1.widgets.net"      { enforce "security" }
\&    host "buildhost.widgets.net" { enforce "security" }
\&    host "dev.widgets.net"       { enforce "security" }
\&    host "prodweb1.widgets.net"  { enforce "security" }
\&    host "prodweb2.widgets.net"  { enforce "security" }
\&    host "proddb1.widgets.net"   { enforce "security" }
\&    host "proddb2.widgets.net"   { enforce "security" }
\&
\&    ############################################################
.Ve
.PP
Congratulations.  You just created your first policy.
.PP
We used extra whitespace to align the \fBenforce\fR keywords
vertically to improve the legibility of the manifest.
Feel free to use extra spaces (or tabs); Clockwork will ignore
them.
.SS "Adding Another Policy"
.IX Subsection "Adding Another Policy"
Let's add to our manifest by defining an \fBissue\fR(5) file in
/etc/issue.  This file contains a banner that will be displayed
to anyone attempting to log into the server.  It looks like this:
.PP
.Vb 5
\&    \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
\&    Unauthorized access to this machine is prohibited.
\&    Use of this system is limited to authorized individuals only.
\&    All activity is monitored.
\&    \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
.Ve
.PP
The master issue file will live on the policy master, in
/var/clockwork/files/banner.  To propagate it to our client hosts,
let's add another policy:
.PP
.Vb 8
\&    policy "banner" {
\&        file "/etc/issue" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0444
\&            source: "/var/clockwork/files/banner"
\&        }
\&    }
.Ve
.PP
The \fBsource\fR attribute of the \fBfile\fR resource instructs the
Clockwork agent to refresh the contents of /etc/issue file from the
version on the server (in /var/clockwork/files/banner).
.PP
Test this new policy by adding it to the host definition for
\&\fIlab1.widgets.net\fR:
.PP
.Vb 4
\&    host "lab1.widgets.net" {
\&        enforce "security" # from before
\&        enforce "banner"
\&    }
.Ve
.PP
As you can see, a host can enforce multiple policies simultaneously.
.PP
Policies can also \fBextend\fR other policies.  Rather than keep the
\&\*(L"security\*(R" and \*(L"banner\*(R" policies separate, and enforce each of them on
every host, we can create another policy to glue the other two
together:
.PP
.Vb 4
\&    policy "base" {
\&        extend "security"
\&        extend "banner"
\&    }
\&
\&    host "lab1.widgets.net" {
\&        enforce "base"
\&    }
.Ve
.PP
By combining the two policies in \*(L"base\*(R", we can keep our \fBhost\fR
definitions clean.  Here is the manifest so far, in its entirety:
.PP
.Vb 2
\&    ############################################################
\&    # /etc/clockwork/manifest.pol
\&
\&    policy "base" {
\&        extend "banner"
\&        extend "security"
\&    }
\&
\&    policy "banner" {
\&
\&        file "/etc/issue" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0444
\&            source: "/var/clockwork/files/banner"
\&        }
\&    }
\&
\&    policy "security" {
\&
\&        file "/etc/sudoers" {
\&            owner: "root"
\&            group: "root"
\&            mode:  0440
\&        }
\&    }
\&
\&    host "lab1.widgets.net"      { enforce "base" }
\&    host "buildhost.widgets.net" { enforce "base" }
\&    host "dev.widgets.net"       { enforce "base" }
\&    host "prodweb1.widgets.net"  { enforce "base" }
\&    host "prodweb2.widgets.net"  { enforce "base" }
\&    host "proddb1.widgets.net"   { enforce "base" }
\&    host "proddb2.widgets.net"   { enforce "base" }
\&
\&    ############################################################
.Ve
.PP
\&\fBNote:\fR
For the sake of brevity, example manifests will not have a lot of
comments.  You are strongly encouraged to use comments in your
real manifests.
.SH "ADVANCED CONFIGURATION"
.IX Header "ADVANCED CONFIGURATION"
This section continues the tutorial from the last section, and
introduces more advanced constructs for policy manifests.
.SS "Adding More Resources"
.IX Subsection "Adding More Resources"
Up until now, each policy we have defined (\*(L"security\*(R" and \*(L"banner\*(R")
has contained only one resource.  This was done deliberately, to
keep things simple, but Clockwork allows you to define as many
resources in any given policy.
.PP
To illustrate this, let's extend our \*(L"security\*(R" policy a bit.
The policy already ensures that the /etc/sudoers file has the
appropriate ownership and permissions, but does not ensure that
the \fBsudo\fR package is installed.  To fix that, we can add
a \fBpackage\fR resource, like this:
.PP
.Vb 1
\&    policy "security" {
\&
\&        # The /etc/sudoers definition from before
\&        file "/etc/sudoers" {
\&            owner: "root"
\&            group: "root"
\&            mode:  0440
\&        }
\&
\&        # Make sure that sudo is actually installed
\&        package "sudo" { installed: "yes" }
\&    }
.Ve
.PP
Now, the sudo package will be installed if it isn't already.
.SS "Including Other Files"
.IX Subsection "Including Other Files"
In a real-world implementation, your manifest will contain dozens
of policies and hundreds of resources (or more).  Keeping all of
these in one file can become unmanageable, especially
if you keep your manifest in version control (see
=item \fB\s-1BEST PRACTICES\s0\fR).
Through the \fBinclude\fR pre-processor irective, you can
split your manifest definition up into multiple files.
.PP
Continuing with our running example, let's split the manifest into
three separate files: one for policy definitions, one for host
definitions, and a third to pull it all together.
.PP
The policies themselves will be stored in
/etc/clockwork/policies.pol:
.PP
.Vb 6
\&    $ cat /etc/clockwork/policies.pol
\&    ############################################################
\&    # /etc/clockwork/policies.pol
\&    #
\&    # Widgets, Inc. Clockwork Policies
\&    #
\&
\&    policy "base" {
\&        extend "banner"
\&        extend "security"
\&    }
\&
\&    policy "banner" {
\&
\&        file "/etc/issue" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0444
\&            source: "/var/clockwork/files/banner"
\&        }
\&    }
\&
\&    policy "security" {
\&
\&        file "/etc/sudoers" {
\&            owner: "root"
\&            group: "root"
\&            mode:  0440
\&        }
\&
\&        package "sudo" { installed: "yes" }
\&    }
\&
\&    ############################################################
.Ve
.PP
Host definitions will be kept in /etc/clockwork/hosts.pol:
.PP
.Vb 6
\&    $ cat /etc/clockwork/hosts.pol
\&    ############################################################
\&    # /etc/clockwork/hosts.pol
\&    #
\&    # Widgets, Inc. Clockwork Host Definitions
\&    #
\&
\&    host "lab1.widgets.net"      { enforce "base" }
\&    host "buildhost.widgets.net" { enforce "base" }
\&    host "dev.widgets.net"       { enforce "base" }
\&    host "prodweb1.widgets.net"  { enforce "base" }
\&    host "prodweb2.widgets.net"  { enforce "base" }
\&    host "proddb1.widgets.net"   { enforce "base" }
\&    host "proddb2.widgets.net"   { enforce "base" }
\&
\&    ############################################################
.Ve
.PP
And finally, the manifest.pol file will include the other two:
.PP
.Vb 6
\&    $ cat /etc/clockwork/manifest.pol
\&    ############################################################
\&    # /etc/clockwork/manifest.pol
\&    #
\&    # Widgets, Inc. Clockwork Manifest
\&    #
\&
\&    include "policies.pol"
\&    include "hosts.pol"
\&
\&    ############################################################
.Ve
.PP
See the \fB\s-1BEST PRACTICES\s0\fR
section for some useful approaches to splitting up a large manifest.
.SS "Conditionals"
.IX Subsection "Conditionals"
Not every resource definition applies to every host.  What works
on your development servers may not be appropriate for your production
boxes.
.PP
Let's consider the situation with the /etc/sudoers file, from our example.
So far, our policy ensures that the permissions and ownership is properly
set on the file, and that the sudo package is installed, but it says
nothing about the contents of /etc/sudoers.
.PP
Let's get started with a sudo configuration for the lab1 server.
Here is our working /etc/sudoers file:
.PP
.Vb 4
\&    # /etc/sudoers \- sudo configuration
\&    #
\&    # for lab1.widgets.net ONLY
\&    #
\&
\&    # Allow admins to do anything as anybody
\&    %admins ALL = (ALL) ALL
\&
\&    # Allow the developers to restart apache
\&    %coders ALL = (root) /etc/init.d/apache
.Ve
.PP
If we store this in /var/clockwork/files/sudoers.lab, we can amend the
file resource in the \*(L"security\*(R" policy to read:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&            source: "/var/clockwork/files/sudoers.lab
\&        }
\&    }
.Ve
.PP
\&\fB\s-1BUT WAIT\s0!\fR
The \*(L"security\*(R" policy applies to all of our hosts, not just lab1.  This
change would inadvertantly open up security leaks on the production servers!
.PP
\&\fB\s-1NOTE:\s0 Self-induced Pedagogical Ignorance\fR
.PP
\&\fBsudo\fR enables you to define a single /etc/sudoers with host-specific
access baked in.  For this lesson, however, we will ignore all that.
.PP
To do this securely, we still need to define \fBsource\fR, but only for
lab1.widgets.net.  Through the \fBif\fR conditional, we can do just that:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&
\&            # only set the source for lab1
\&            if (sys.hostname == "lab1") {
\&                source: "/var/clockwork/files/sudoers.lab
\&            }
\&        }
\&    }
.Ve
.PP
Now, the \fBsource\fR attribute of /etc/sudoers will only be present if
when the policy is enforced on a system with the hostname of \fIlab1\fR.
.PP
Where did \fIsys.hostname\fR come from?
.PP
It's called a \fBfact\fR, and it represents some piece of information about
the client host.  Host policies are always evaluated against the facts
before enforcement.
.PP
To see a list of facts, just run \fBfact\fR(1):
.PP
.Vb 10
\&    $ fact | sort
\&    lsb.distro.codename = lucid
\&    lsb.distro.description = Ubuntu 10.04.2 LTS
\&    lsb.distro.id = Ubuntu
\&    lsb.distro.release = 10.04
\&    sys.arch = i686
\&    sys.fqdn = box.niftylogic.net
\&    sys.hostid = 007f0100
\&    sys.hostname = box
\&    sys.kernel.major = 2.6
\&    sys.kernel.minor = 2.6.32
\&    sys.kernel.version = 2.6.32\-32\-generic
\&    sys.platform = Linux
\&    time.hour = 16
\&    time.mday = 21
\&    time.minute = 39
\&    time.month = 06
\&    time.second = 55
\&    time.weekday = tue
\&    time.year = 2011
\&    time.yearday = 172
.Ve
.PP
We can take this further with more \fBelse if\fR and \fBelse\fR clauses:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&
\&            if (sys.hostname == "lab1") {
\&                source: "/var/clockwork/files/sudoers.lab"
\&            } else if (sys.hostname == "buildhost") {
\&                source: "/var/clockwork/files/sudoers.prod"
\&            } else if (sys.hostname == "prodweb1") {
\&                source: "/var/clockwork/files/sudoers.prod"
\&            } else if (sys.hostname == "prodweb2") {
\&                source: "/var/clockwork/files/sudoers.prod"
\&            } else if (sys.hostname == "proddb1") {
\&                source: "/var/clockwork/files/sudoers.db"
\&            } else if (sys.hostname == "proddb2") {
\&                source: "/var/clockwork/files/sudoers.db"
\&            } else if (sys.hostname == "dev") {
\&                source: "/var/clockwork/files/sudoers.dev"
\&            }
\&        }
\&    }
.Ve
.PP
To make things a little more manageable, we can use Perl-comaptible
regular expressions in our conditionals:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&
\&            if (sys.hostname == "lab1") {
\&                source: "/var/clockwork/files/sudoers.lab"
\&            } else if (sys.hostname == "buildhost") {
\&                source: "/var/clockwork/files/sudoers.prod"
\&            } else if (sys.hostname =~ m/^prodweb/) {
\&                source: "/var/clockwork/files/sudoers.prod"
\&            } else if (sys.hostname =~ m/^proddb/) {
\&                source: "/var/clockwork/files/sudoers.db"
\&            } else if (sys.hostname == "dev") {
\&                source: "/var/clockwork/files/sudoers.dev"
\&            }
\&        }
\&    }
.Ve
.PP
This large \fBif\fR construct sets the \fBsource\fR for /etc/sudoers
to one of four version (lab, prod, db or dev) based on the hostname.
.PP
While it works, it is unwieldy and difficult to read.  Instead, we can
use the \fBmap\fR conditional construct:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&
\&            source: map(sys.hostname) {
\&              "lab1":      "/var/clockwork/files/sudoers.lab"
\&              "buildhost": "/var/clockwork/files/sudoers.prod"
\&              /^prodweb/:  "/var/clockwork/files/sudoers.prod"
\&              /^proddb/:   "/var/clockwork/files/sudoers.db"
\&              "dev":       "/var/clockwork/files/sudoers.dev"
\&            }
\&        }
\&    }
.Ve
.PP
Each line inside of the \fBmap\fR block defines an \fIalternate\fR. \fBmap\fR
chooses one of the alternates based on the value of the fact being mapped,
in this case, \fIsys.hostname\fR.
.PP
There is a special alternate, called \fBelse\fR that acts like the \fBelse\fR
clause of an \fBif\fR construct: if none of the alternates match, then the
value specified for \fBelse\fR is used.
.PP
This allows us to simplify the policy definition even more:
.PP
.Vb 2
\&    policy "security" {
\&        # other resources omitted for clarity
\&
\&        file "/etc/sudoers" {
\&            owner:  "root"
\&            group:  "root"
\&            mode:   0440
\&
\&            source: map(sys.hostname) {
\&              "lab1":      "/var/clockwork/files/sudoers.lab"
\&              /^proddb/:   "/var/clockwork/files/sudoers.db"
\&              "dev":       "/var/clockwork/files/sudoers.dev"
\&              else:        "/var/clockwork/files/sudoers.prod"
\&            }
\&        }
\&    }
.Ve
.PP
\&\fBif\fR conditionals aren't limited just to resource values.  You can
conditionally define entire resources:
.PP
.Vb 1
\&    policy "package\-tools" {
\&
\&        if (lsb.distro.id == "Ubuntu") {
\&            package "apt\-file"  { installed: "yes" }
\&            package "apt\-utils" { installed: "yes" }
\&
\&        } else if (lsb.distro.id == "Redhat") {
\&            package "yum\-tools" { installed: "yes" }
\&        }
\&    }
.Ve
.PP
Here, we define different package resource based on the distribution
of Linux.  Ubuntu clients will install some \s-1APT\s0 packages, while
Redhat clients will install yum-tools.  Other distributions,
like CentOS or Gentoo, will have neither resource defined.
.PP
\&\fBNote:\fR
the \fBmap\fR conditional can only be used inside of resource attribute
definitions.  It is a bit of convenience syntax to help keep manifests
clean and understandable.
.PP
The conditional test can also be combined with the \fIand\fR, \fIor\fR
and \efInot\efB operators, to make more complicated conditionals:
.PP
.Vb 3
\&    if (sys.arch == "x86_64" and sys.fqdn =~ /dev/) {
\&        # ...
\&    }
\&
\&    if ((sys.fqdn =~ /dev/ or custom.fact == "dev")
\&         and lsb.distro.id == "Ubuntu") {
\&        # ...
\&    }
.Ve
.PP
Regular expressions can be specified as \fB m/.../\fR, \fB/.../\fR
(without the leading 'm' identifier) or as \fBm|...|\fR.  The latter
exists to allow patterns with lots of '/' characters to avoid the
constant need to backslash-escape them.  Note that all pipe-delimited
regular expressions \fImust\fR start with 'm'.
.PP
By default, pattern matching is case-sensitive.  To make your regex
match treat upper\- and lower-case characters as interchangeable, append
an 'i' after the closing delimiter, like this:
.PP
.Vb 3
\&    if (fact.name =~ m/foo/i) {
\&        # ...
\&    }
.Ve
.PP
The following conditional operators are understood:
.PP
.Vb 2
\&    ==, is           Strict (exact) equality
\&    !=, is not       Strict (exact) inequality
\&
\&    =~, like         Perl\-compatible regex matching
\&    !~, not like     Negative regex matching
.Ve
.PP
And the following boolean operators are defined:
.PP
.Vb 2
\&    <expr> and <expr>
\&    <expr> && <expr>    Both expressions must evaulate to true
\&
\&    <expr> or <expr>
\&    <expr> || <expr>    Either expressions must evaluate to true
\&                        The second expression will be skipped if
\&                        the first is true.
\&
\&    !<expr>             Negate the expression
\&
\&    (<expr>)            Grouping, to enforce precedence.
.Ve
.PP
There are no precedence rules to remember.  \fBand\fR and \fB&&\fR
are completely interchangeable, as are \fBor\fR and \fB||\fR.
.PP
Conditionals are very powerful parts of the Clockwork manifest
language that can help to produce specific and sophisticated
policy and resource definitions.
.SS "Dependencies"
.IX Subsection "Dependencies"
Clockwork tries to reconcile the actual configuration with the
enforced policy in a single run, and in as few steps as possible.
To do this, it has to take into account inter-dependencies between
resources.
.PP
The simplest dependency is between a file and its parent directories.
.PP
Sometimes, you will want to call out explicit dependencies that
cannot be detected automatically by Clockwork.  For example, services,
packages and configuration files are usually inter-dependent:
.PP
.Vb 10
\&    file "/etc/foo.conf" {
\&        owner:  "root"
\&        group:  "root"
\&        mode:   0644
\&        source: "/files/foo.conf"
\&    }
\&    package "foo\-server" {
\&        version: "1.2.5"
\&    }
\&    service "foo" {
\&        running: "yes"
\&        enabled: "yes"
\&    }
.Ve
.PP
Clockwork can not possibly know how these resources inter-relate,
or even that they are related.  This is where explicit dependencies
come into play:
.PP
.Vb 2
\&    service("foo") depends on package("foo\-server")
\&    file("/etc/foo.conf") affects service("foo")
.Ve
.PP
In this case, the \fIfoo\fR service will not be started until both
the \fIfoo-server\fR package and /etc/foo.conf are enforced.
Furthermore, if the package is every updated, or the configuration
file changes, the service will be reloaded.
.PP
The two types of dependencies (\fBdepends on\fR and \fBaffects\fR)
illustrate the same concept, represented in complementary ways.
\&\*(L"A depends on B\*(R" is quivalent to \*(L"B affects A\*(R".
.PP
Dependencies are activated differently by different resources.
Refer to the resource-specific man pages for more information.
.SS "Overriding Values"
.IX Subsection "Overriding Values"
Clockwork allows resource attributes to be overrided by later
definitions with the same key.
.PP
Consider the following:
.PP
.Vb 1
\&    policy "www" {
\&
\&        package "apache" { installed: "yes" }
\&        package "apache" { installed: "no"  }
\&        package "apache" { installed: "yes" }
\&    }
.Ve
.PP
Although the example is entirely contrived, the concept is not.
The \*(L"www\*(R" policy ultimately comes to the conclusion that the
Apache web server package should be installed.
.PP
Here's a more realistic (and more complicated) example:
.PP
.Vb 1
\&    policy "standard" {
\&
\&        file "/etc/ssh/sshd_config" {
\&            # other attributes omitted for clarity
\&            source: "/var/clockwork/files/sshd.standard"
\&        }
\&
\&        # other resources for the \*(Aqstandard\*(Aq configuration
\&    }
\&
\&    policy "secured" {
\&
\&        file "/etc/ssh/sshd_config" {
\&            # other attributes omitted for clarity
\&            source: "/var/clockwork/files/sshd.secured"
\&        }
\&
\&        # other resources for the \*(Aqsecured\*(Aq configuration
\&    }
\&
\&    host "dev1.example.com" {
\&        enforce "standard"
\&    }
\&    host "ftp1.example.com" {
\&        enforce "standard"
\&        enforce "secured"
\&    }
.Ve
.PP
The ftp1 host has a more secure \s-1SSHD\s0 configuration
than dev1, because the \*(L"secured\*(R" policy (enforced by ftp1)
overrides the \fBsource\fR attribute of the /etc/ssh/sshd_config file.
.SH "AUTHOR"
.IX Header "AUTHOR"
Clockwork was designed and written by James Hunt.

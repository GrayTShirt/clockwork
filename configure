#!/bin/bash

. config.dist
BUILD_MODE=release

help()
{
	cat <<EOF
./configure - Cockwork Build Environment Configurator

This script controls the Clockwork build environment and allows you
to tweak various aspects of the build process, including installation
paths, the names of the clockwork system user / group, etc.

OPTIONS

 --help

     Shows this help message and then exits.

 --user <name>

     Change the name of the clockwork system user that will own all of
     the configuration and variable data files.  If a user by this name
     is not found on the local system, it is created during \`make install'

     Default: clockwork

 --userhome </path/to/home>

     Path to use for the clockwork user's home directory.  This option is
     intended for developers to install to a chroot.pre directory, but with
     a chroot-relative path for the clockwork user's home directory.

     This directory is not explicitly created during installation.

     Default: \$VARDIR/lib/clockwork (see --destdir and --vardir)

 --group <name>

     Change the name of the clockwork system group that will own all of
     the configuration and variable data afiles.  If a group by this name
     is not found on the local system, it is created during \`make install'

     Default: clockwork

 --destdir </path/to/root>

     Path to an alternate root directory, for installation.  For example,
     if you set --destdir to '/opt', then Clockwork configuration files
     will be stored in /opt/etc/clockwork, variable data files in
     /opt/var/clockwork, binaries in /opt/sbin, etc.

     Other ./configure arguments (like --vardir) will override the default
     values based on --destdir.  If you specify those as well, remember
     to use absolute paths.

     Default: /

 --sbindir </path/to/sbin>

     Override the path that the Clockwork binaries will be stored in.

     Default: \$DESTDIR/sbin

 --vardir </path/to/var>

     Override the path for storing variable data (PID files, DBs, etc.)

     Default: \$DESTDIR/var

 --usrdir </path/to/usr>

     Override the path for storing usr data (shared resources, docs, etc.)

     Default: \$DESTDIR/usr

 --etcdir </path/to/etc>

     Override the path for storing Clockwork configuration files.

     Default: \$DESTDIR/etc/clockwork

 --mandir </path/to/man>

     Override the path for storing the Clockwork man pages.  Additional
     directories (man1 and man5) will be created under this path during
     the installation phase.

     Default: \$USRDIR/share/man

 --agent-only

     Instruct the build system to only build the components necessary for
     an agent installation (cwa, cwcert, related manpages, etc.)

     By default, both the agent and master components are built / installed.

     This option is mutually-exclusive with --master-only

 --master-only

     Instruct the build system to only build the components necessary for
     a policy master installation (policyd, cwca, related manpages, etc.)

     By default, both the agent and master components are built / installed.

     This option is mutually-exclusive with --agent-only

 --show

     Do not generate a new configuration; instead, parse and summarize
     the existing configuration in ./config.

     This option is intended primarily for Clockwork developers and
     package maintainers.  (Note: any arguments after --show are ignored)

 --development

     Configure the build environment with the appropriate profiling and
     debugging support that Clockwork developers need.  If you don't know
     what this is, you probably don't need it.  :-)

EOF
}

process()
{
	while [[ ! -z "$1" ]]; do
		case $1 in
		--help)
			help; exit 0
			;;

		--show)
			. config
			normalize
			summary
			exit 0
			;;

		--user)
			shift; CWUSER=$1
			;;

		--group)
			shift; CWGROUP=$1
			;;

		--userhome)
			shift; HOMEDIR=$1;
			;;

		--destdir)
			shift; DESTDIR=$1
			;;

		--sbindir)
			shift; SBINDIR=$1
			;;

		--usrdir)
			shift; USRDIR=$1
			;;

		--vardir)
			shift; VARDIR=$1
			;;

		--etcdir)
			shift; ETCDIR=$1
			;;

		--mandir)
			shift; MANDIR=$1
			;;

		--agent-only)
			BUILD_AGENT=Y
			BUILD_MASTER=N
			;;

		--master-only)
			BUILD_AGENT=N
			BUILD_MASTER=Y
			;;

		--development)
			BUILD_MODE=development
			;;

		*)
			echo "Unknown option: $1"
			echo "Try $0 --help for configuration options"
			exit 1;
			;;
		esac

		shift
	done
}

normalize()
{
	[[ -z "$SBINDIR" ]] && SBINDIR="$DESTDIR/sbin"
	[[ -z "$VARDIR"  ]] && VARDIR="$DESTDIR/var"
	[[ -z "$USRDIR"  ]] && USRDIR="$DESTDIR/usr"
	[[ -z "$ETCDIR"  ]] && ETCDIR="$DESTDIR/etc/clockwork"
	[[ -z "$MANDIR"  ]] && MANDIR="$USRDIR/share/man"
	[[ -z "$HOMEDIR" ]] && HOMEDIR="$VARDIR/lib/clockwork"
}

summary()
{
	echo "==================================="
	echo "Clockwork will be built as follows:"
	echo
	echo "CWVERSION:   $CWVERSION"
	echo "Environment: $BUILD_MODE"
	echo
	echo "User:  $CWUSER"
	echo "Group: $CWGROUP"
	echo
	echo "DESTDIR: $DESTDIR/"
	echo
	echo "SBINDIR: $SBINDIR"
	echo "VARDIR:  $VARDIR"
	echo "USRDIR:  $USRDIR"
	echo "ETCDIR:  $ETCDIR"
	echo "MANDIR:  $MANDIR"
	echo "HOMEDIR: $HOMEDIR"
	echo
	echo "Build agent tools?    [ $BUILD_AGENT ]"
	echo "Build master tools?   [ $BUILD_MASTER ]"
	echo
	echo "==================================="
}

save()
{
	(echo "# Clockwork build / install configuration generated $(date)"
	 echo
	 for VAR in CWVERSION CWUSER CWGROUP \
		DESTDIR SBINDIR VARDIR USRDIR ETCDIR MANDIR HOMEDIR \
		BUILD_MODE BUILD_AGENT BUILD_MASTER; do
		echo "$VAR=$(eval echo \$$VAR)"
	 done) > config

	echo "configuration saved to ./config"

	(echo "/* Clockwork build / install configuration generated $(date) */"
	 echo "#ifndef CONFIG_H"
	 echo "#define CONFIG_H"
	 echo
	 for VAR in VARDIR USRDIR ETCDIR; do
		echo "#define CW_$VAR \"$(eval echo \$$VAR)\""
	 done
	 echo
	 echo "#endif") > config.h
	echo "macro definitions saved to ./config.h"
}

CWVERSION=$(grep CLOCKWORK_VERSION clockwork.h | sed -e 's/.*"\(.*\)".*/\1/')
if [[ -z "$CWVERSION" ]]; then
	echo "Failed to determine Clockwork version!"
	exit 1;
fi
process $@
normalize
summary
save
